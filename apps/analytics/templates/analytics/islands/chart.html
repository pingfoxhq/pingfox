{% load static %}

<div class="mb-6">
    <h3 class="title is-4 has-text-white mb-4">Site Traffic Chart</h3>

    <!-- Tabs -->
    <div class="tabs is-toggle is-toggle-rounded is-small mb-4">
        <ul>
            <li data-range="daily" class="tab-btn">
                <a><span>Daily</span></a>
            </li>
            <li data-range="hourly" class="tab-btn">
                <a><span>Hourly</span></a>
            </li>
            <li data-range="minute" class="tab-btn">
                <a><span>Per Minute</span></a>
            </li>
        </ul>
    </div>

    <!-- Chart container -->
    <canvas id="siteChart" height="150"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let site_id = "{{ site.site_id }}";
    let ctx = document.getElementById("siteChart").getContext("2d");
    let chartInstance = null;
    let range = localStorage.getItem('chartRange') || 'daily';

    const fetchChartData = async (range) => {
        const res = await fetch(`/api/analytics/chart-data/?site_id=${site_id}&range=${range}`, {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        const json = await res.json();
        const label = json.map(item => item.label);
        const data = json.map(item => item.count);
        return { label, data };
    };

    const renderChart = (range) => {
        fetchChartData(range).then(result => {
            if (!result) return;
            const { label, data } = result;

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: label,
                    datasets: [{
                        label: `${range.charAt(0).toUpperCase() + range.slice(1)} Views`,
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#ccc' },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#ccc' },
                            grid: { color: '#333' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#eee' }
                        }
                    }
                }
            });
        });
    };

    document.querySelectorAll('.tab-btn').forEach(li => {
        li.addEventListener('click', () => {
            const range = li.dataset.range;
            localStorage.setItem('chartRange', range);
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('is-active'));
            li.classList.add('is-active');
            renderChart(range);
        });
    });

    document.addEventListener("htmx:afterSettle", () => {
        const currentRange = localStorage.getItem('chartRange') || 'daily';
        document.querySelector(`.tab-btn[data-range="${currentRange}"]`)?.classList.add('is-active');
        renderChart(currentRange);
    });

    renderChart(range);

    setInterval(() => {
        const currentRange = localStorage.getItem('chartRange') || 'daily';
        fetchChartData(currentRange).then(result => {
            if (result) {
                const { label, data } = result;
                chartInstance.data.labels = label;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update();
            }
        });
    }, 60000);
</script>