{% extends 'base.html' %}

{% block title %}UI Builder - {{ form.name }}{% endblock %}

{% block content %}
<div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
  <h1 class="title is-3 has-text-white">{{ form.name }}</h1>
  <a href="{% url 'forms:list' %}" class="button is-small">
    &larr; Back to Forms List
  </a>
</div>

<p class="is-size-7 has-text-grey-light mb-5">{{ form.description }}</p>

{% include 'core/islands/tab.html' with active_tab="forms" %}

<div class="mb-6" x-data="formBuilder('{{ form.slug }}')">
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-5">
    <h2 class="title is-4 has-text-white">üõ†Ô∏è Build Your Form</h2>
    <div class="buttons">
      <a href="{% url 'forms:editor' form.slug %}" class="button is-light is-small is-outlined">Switch to Schema Editor</a>
      <button class="button is-light is-small" @click="submit()">üíæ Save Form</button>
    </div>
  </div>

  <noscript>
    <div class="notification is-warning">
      <strong>Warning!</strong> JavaScript is disabled. The form builder needs JavaScript to work.
      <br>
      You can still use the <a href="{% url 'forms:editor' form.slug %}">Schema Editor</a>.
    </div>
  </noscript>

  <div class="columns is-variable is-6">

    <!-- Sidebar -->
    <div class="column is-3 box">
      <h2 class="is-size-7 has-text-grey has-text-weight-semibold is-uppercase">Add Field</h2>
      <p class="help is-size-7 mb-3">
        Click a field type below to add it to your form.
      </p>
      <template x-for="field in fieldTypes" :key="field.type">
        <button class="button is-fullwidth is-small is-outlined mb-2 is-light" @click="addField(field)">
          <span x-text="field.label"></span>
        </button>
      </template>
    </div>

    <!-- Builder Canvas -->
    <div class="column is-9 box">
      <h2 class="is-size-6 has-text-weight-semibold has-text-white mb-3">Form Preview</h2>
      <template x-if="fields.length === 0">
        <p class="has-text-grey-light is-italic is-size-7">Click a field to add it to your form.</p>
      </template>

      <div class="mb-5" x-ref="sortable" x-init="makeSortable()">
        <template x-for="(field, index) in fields" :key="field._id">
          <div class="box has-background-black mb-3">
            <div class="is-flex is-justify-content-space-between is-align-items-start mb-2">
              <div class="is-flex-grow-1">
                <input type="text" class="input is-small" x-model="field.label">
                <p class="is-size-7 has-text-grey mt-1" x-text="`Type: ${field.type}`"></p>
              </div>
              <button class="button is-small is-danger ml-4" @click="removeField(index)">‚úï</button>
            </div>

            <button class="is-size-7 has-text-link is-underline" @click="field._showAdvanced = !field._showAdvanced">
              Advanced settings
            </button>

            <div x-show="field._showAdvanced" class="mt-3">
              <div class="field is-grouped is-grouped-multiline mb-2">
                <div class="control is-expanded">
                  <input class="input is-small" type="text" x-model="field.help_text" placeholder="Help text (optional)">
                </div>
                <div class="control is-expanded">
                  <input class="input is-small" type="text" x-model="field.placeholder" placeholder="Placeholder (optional)">
                </div>
                <div class="control is-expanded">
                  <input class="input is-small" type="text" x-model="field.validation" placeholder="Validation (e.g. email)">
                </div>
                <div class="control is-expanded">
                  <input class="input is-small" type="text" x-model="field.default_value" placeholder="Default Value (optional)">
                </div>
              </div>

              <div class="field is-grouped is-grouped-multiline is-size-7 mb-2">
                <label class="checkbox mr-4">
                  <input type="checkbox" x-model="field.required"> Required
                </label>
                <label class="checkbox mr-4">
                  <input type="checkbox" x-model="field.readonly"> Readonly
                </label>
                <label class="checkbox mr-4">
                  <input type="checkbox" x-model="field.hidden"> Hidden
                </label>
                <label class="checkbox">
                  <input type="checkbox" x-model="field.disabled"> Disabled
                </label>
              </div>
            </div>

            <template x-if="['select', 'radio'].includes(field.type)">
              <div>
                <label class="label is-small has-text-grey">Options</label>
                <template x-for="(opt, optIdx) in field.options" :key="optIdx">
                  <div class="field has-addons mb-2">
                    <div class="control is-expanded">
                      <input class="input is-small" type="text" x-model="field.options[optIdx]">
                    </div>
                    <div class="control">
                      <button class="button is-small is-danger is-light" @click="field.options.splice(optIdx, 1)">‚úï</button>
                    </div>
                  </div>
                </template>
                <button class="button is-small is-outlined" @click="field.options.push('New Option')">+ Add Option</button>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Live Preview -->
  <div class="my-6">
    <button class="button is-small is-outlined is-light" @click="renderLivePreview()">üîÅ Refresh Preview</button>
    <h2 class="is-size-6 has-text-weight-semibold has-text-white my-2">Live Preview</h2>
    <div class="box" x-html="livePreviewHtml"></div>
  </div>
</div>

<script>
  document.addEventListener("htmx:afterSettle", () => {
    Alpine.initTree(document.body);
  });

  // Alpine component for form builder
function formBuilder(slug) {
    return {
      fieldTypes: [
        { type: 'text', label: 'Text Input' },
        { type: 'email', label: 'Email' },
        { type: 'textarea', label: 'Textarea' },
        { type: 'select', label: 'Select' },
        { type: 'checkbox', label: 'Checkbox' },
        { type: 'radio', label: 'Radio' },
      ],
      fields: [],
      livePreviewHtml: '',


      init() {
        fetch("{% url 'forms:schema' form.slug %}")
          .then(res => res.json())
          .then(data => {
            this.fields = data.map((field, index) => ({
              _id: Date.now() + Math.random(),
              name: field.name || field.label.toLowerCase().replace(/\s+/g, '_'),
              label: field.label || '',
              type: field.type || 'text',
              required: field.required || false,
              readonly: field.readonly || false,
              hidden: field.hidden || false,
              disabled: field.disabled || false,
              help_text: field.help_text || '',
              placeholder: field.placeholder || '',
              validation: field.validation || '',
              default_value: field.default_value || '',
              options: field.options || (['select', 'radio'].includes(field.type) ? ['Option 1', 'Option 2'] : null),
              order: field.order || index
            }));
            this.renderLivePreview();
          })
          .catch(err => {
            console.error("Failed to fetch schema:", err);
          });
      },

      addField(fieldType) {
        const baseName = fieldType.label.toLowerCase().replace(/\s+/g, '_');
        let name = baseName;
        let counter = 1;

        // Ensure the name is unique
        while (this.fields.some(f => f.name === name)) {
          name = `${baseName}_${counter}`;
          counter++;
        }

        this.fields.push({
          _id: Date.now() + Math.random(),
          name: name,
          label: fieldType.label,
          type: fieldType.type,
          required: false,
          readonly: false,
          hidden: false,
          disabled: false,
          help_text: '',
          placeholder: '',
          validation: '',
          default_value: '',
          options: ['select', 'radio'].includes(fieldType.type) ? ['Option 1', 'Option 2'] : null,
          order: this.fields.length
        });
        this.renderLivePreview();

      },

      removeField(index) {
        this.fields.splice(index, 1);
        this.renderLivePreview();

      },

      makeSortable() {
        const el = this.$refs.sortable;
        Sortable.create(el, {
          animation: 150,
          onEnd: (evt) => {
            const movedItem = this.fields.splice(evt.oldIndex, 1)[0];
            this.fields.splice(evt.newIndex, 0, movedItem);
          }
        });
      },

      submit() {
        fetch("{% url 'forms:save' form.slug %}", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ fields: this.fields })
        })
          .then(res => {
            if (!res.ok) throw new Error("Failed to save");
            return res.json();
          })
          .then(data => {
            alert("‚úÖ Form saved successfully!");
          })
          .catch(err => {
            alert("‚ùå Error saving form.");
            console.error(err);
          });
      },
      renderLivePreview() {

        const formData = new FormData();
        formData.append('schema', JSON.stringify(this.fields));

        fetch("{% url 'forms:convert' %}", {
          method: "POST",
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: formData
        })
          .then(res => {
            if (!res.ok) throw new Error("Conversion failed");
            return res.text();
          })
          .then(html => {
            this.livePreviewHtml = html;
          })
          .catch(err => {
            console.error("Preview error:", err);
            if (this.fields.length === 0) {
              this.livePreviewHtml = "<p class='text-gray-500 text-sm'>No fields added yet. Click a field type to add it.</p>";
              return;
            }
            this.livePreviewHtml = "<p class='text-red-500 text-sm'>Failed to render preview.</p>";
          });
      }
    };
  }




</script>

{% endblock content %}